<!DOCTYPE html>
<html>
<head>
<title>KP Scan Document</title>
<script type="text/javascript" src="Resources/dynamsoft.webtwain.initiate.js"></script>
<script type="text/javascript" src="Resources/dynamsoft.webtwain.config.js"></script>
<style>

        body {

            font-family: Arial, sans-serif;

            display: flex;

            flex-direction: column;

            align-items: center;

            background-color: #f4f4f4;

            height: 100vh;

        }
 
        #dwtcontrolContainer {

            width: 400px;

            height: 500px;

            background-color: white;

            border: 2px solid #ccc;

            margin-top: 60px;

        }
 
        #message {

            margin-top: 20px;

            font-size: 18px;

            color: green;

            font-weight: bold;

        }
 
        #output {

            margin-top: 10px;

            width: 90%;

            max-width: 800px;

            background-color: #fff;

            border: 1px solid #ccc;

            padding: 15px;

            word-wrap: break-word;

            white-space: pre-wrap;

            font-size: 14px;

            color: #333;

        }
</style>
</head>
<body>
 
    <div id="dwtcontrolContainer"></div>
<div id="message">Waiting for scan...</div>
<div id="output"></div>
 
    <script type="text/javascript">

        var DWTObject;
 
        Dynamsoft.DWT.RegisterEvent("OnWebTwainReady", function () {

            DWTObject = Dynamsoft.DWT.GetWebTwain('dwtcontrolContainer');

            if (DWTObject) {

                startScanAutomatically();

            }

        });
 
        function startScanAutomatically() {

            DWTObject.GetSourceNamesAsync()

                .then(sources => {

                    if (sources.length === 0) {

                        displayError("❌ No scanner detected.");

                        Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnScanError", ["No scanner detected."]);

                        throw new Error("No scanner detected.");

                    }

                    return DWTObject.OpenSourceAsync();

                })

                .then(() => DWTObject.AcquireImageAsync({ IfCloseSourceAfterAcquire: true }))

                .then(() => convertPDFToBase64())

                .catch(exp => {

                    displayError("❌ Scan error: " + exp.message);

                    Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnScanError", [exp.message]);

                });

        }
 
        function convertPDFToBase64() {

            if (DWTObject.HowManyImagesInBuffer > 0) {

                DWTObject.ConvertToBlob(

                    [0],

                    Dynamsoft.DWT.EnumDWT_ImageType.IT_PDF,

                    function (result, indices, blob) {

                        const reader = new FileReader();

                        reader.onloadend = function () {

                            if (reader.result) {

                                const base64String = reader.result.split(',')[1];
 
                                // ✅ Show preview in alert (first 500 chars)

                                alert("✅ Base64 PDF preview:\n\n" + base64String.substring(0, 500) + "...");
 
                                // ✅ Show full in output div

                                displaySuccess("✅ Scan successful! Base64 PDF generated below:", base64String);
 
                                // ✅ Send to Business Central

                                Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnPDFBase64Ready", [base64String]);

                            } else {

                                alert("❌ Failed to read PDF blob.");

                                Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnScanError", ["FileReader failed to read blob."]);

                            }

                        };

                        reader.onerror = function () {

                            alert("❌ FileReader error while converting blob.");

                            Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnScanError", ["FileReader error occurred."]);

                        };

                        reader.readAsDataURL(blob);

                    },

                    function (errCode, errString) {

                        displayError("❌ PDF conversion failed: " + errString);

                        Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnScanError", ["PDF conversion failed: " + errString]);

                    }

                );

            } else {

                displayError("❌ No scanned image in buffer.");

                Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnScanError", ["No scanned image in buffer."]);

            }

        }
 
        function displaySuccess(message, base64) {

            document.getElementById("message").textContent = message;

            document.getElementById("message").style.color = "green";

            document.getElementById("output").textContent = base64;

        }
 
        function displayError(errorMessage) {

            document.getElementById("message").textContent = errorMessage;

            document.getElementById("message").style.color = "red";

            document.getElementById("output").textContent = "";

        }
</script>
</body>
</html>

 
