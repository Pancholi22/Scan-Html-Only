<!DOCTYPE html>
<html>
<head>
    <title>KP Scan Document</title>
    <script type="text/javascript" src="Resources/dynamsoft.webtwain.initiate.js"></script>
    <script type="text/javascript" src="Resources/dynamsoft.webtwain.config.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f4;
            height: 100vh;
        }

        #dwtcontrolContainer {
            width: 400px;
            height: 500px;
            background-color: white;
            border: 2px solid #ccc;
            margin-top: 60px;
        }

        #output {
            margin-top: 20px;
            width: 90%;
            max-width: 800px;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 15px;
            word-wrap: break-word;
            white-space: pre-wrap;
            font-size: 14px;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="dwtcontrolContainer"></div>
    <div id="output">Waiting for scan...</div>

    <script type="text/javascript">
        var DWTObject;

        Dynamsoft.DWT.RegisterEvent("OnWebTwainReady", function () {
            DWTObject = Dynamsoft.DWT.GetWebTwain('dwtcontrolContainer');
            if (DWTObject) {
                startScanAutomatically();
            }
        });

        function startScanAutomatically() {
            DWTObject.GetSourceNamesAsync()
                .then(sources => {
                    if (sources.length === 0) {
                        displayOutput("Error: No scanner detected.");
                        Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnScanError", ["No scanner detected."]);
                        throw new Error("No scanner detected.");
                    }
                    return DWTObject.OpenSourceAsync();
                })
                .then(() => DWTObject.AcquireImageAsync({ IfCloseSourceAfterAcquire: true }))
                .then(() => convertPDFToBase64())
                .catch(exp => {
                    displayOutput("Scan error: " + exp.message);
                    Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnScanError", [exp.message]);
                });
        }

        function convertPDFToBase64() {
            if (DWTObject.HowManyImagesInBuffer > 0) {
                DWTObject.ConvertToBlob(
                    [0], // Convert first image, or all images with [0,1,2,...]
                    Dynamsoft.DWT.EnumDWT_ImageType.IT_PDF,
                    function (result, indices, blob) {
                        const reader = new FileReader();
                        reader.onloadend = function () {
                            const base64String = reader.result.split(',')[1]; // Remove data:application/pdf;base64,
                            displayOutput(base64String);
                            Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnPDFBase64Ready", [base64String]);
                        };
                        reader.readAsDataURL(blob);
                    },
                    function (errCode, errString) {
                        displayOutput("PDF conversion failed: " + errString);
                        Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnScanError", ["PDF conversion failed: " + errString]);
                    }
                );
            } else {
                displayOutput("Error: No scanned image in buffer.");
                Microsoft.Dynamics.NAV.InvokeExtensibilityMethod("OnScanError", ["No scanned image in buffer."]);
            }
        }

        function displayOutput(message) {
            document.getElementById("output").textContent = message;
        }
    </script>
</body>
</html>
